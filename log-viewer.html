<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æµ·ç”Ÿé¤¨ç ”ç©¶æ•¸æ“šå®Œæ•´å ±è¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .report-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        /* .table-header { @apply bg-slate-100 text-slate-600 text-[11px] font-bold p-3 border-b; }
        .table-cell { @apply p-3 border-b text-sm text-slate-700; }
        .stat-val { @apply text-2xl font-black text-indigo-600; }
        /* è¡¨æ ¼æ¨™é ­ - å–ä»£ @apply */
        .table-header { 
            background-color: #f1f5f9; 
            color: #475569; 
            font-size: 11px; 
            font-weight: 700; 
            padding: 0.75rem; 
            border-bottom: 1px solid #e2e8f0; 
        }
        /* è¡¨æ ¼å„²å­˜æ ¼ - å–ä»£ @apply */
        .table-cell { 
            padding: 0.75rem; 
            border-bottom: 1px solid #e2e8f0; 
            font-size: 0.875rem; 
            color: #334155; 
        }
        /* çµ±è¨ˆæ•¸å€¼å¼·èª¿ - å–ä»£ @apply */
        .stat-val { 
            font-size: 1.5rem; 
            font-weight: 900; 
            color: #4f46e5; 
        }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        
        <div class="no-print space-y-4 mb-8">
            <div class="flex justify-between items-center">
                <button onclick="history.back()" class="text-indigo-600 font-bold hover:underline">â¬…ï¸ è¿”å›ç´€éŒ„ç«¯</button>
                <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 active:scale-95 transition-all flex items-center gap-2">
                    ğŸ“Š è¼¸å‡ºå®Œæ•´ Excel å ±è¡¨ (CSV)
                </button>
            </div>

            <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white">
                <h2 class="text-lg font-bold mb-4">ğŸ“… å ±è¡¨æ™‚é–“é€±æœŸç¯©é¸</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <button onclick="filterData('all')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">å…¨éƒ¨æ­·å²</button>
                    <button onclick="filterData('day')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">ä»Šæ—¥</button>
                    <button onclick="filterData('week')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">é€±å ±</button>
                    <button onclick="filterData('month')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">æœˆå ±</button>
                    <button onclick="filterData('year')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">å¹´å ±</button>
                </div>
                <p id="filter-status" class="mt-4 text-indigo-100 text-sm italic italic">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div id="report-content">
            <h1 class="text-3xl font-black text-slate-800 mb-8 border-l-8 border-indigo-600 pl-4">è§€çœ¾è¡Œç‚ºç ”ç©¶åˆ†æå®Œæ•´å ±è¡¨</h1>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="report-card">
                    <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-1ï¼šæˆå“¡çµ„åˆçµ±è¨ˆ</h3>
                    <table class="w-full text-left"><tbody id="table-4-1"></tbody></table>
                </div>
                <div class="report-card">
                    <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-2ï¼šå„å€åŸŸåœç•™æ™‚é–“åˆ†æ</h3>
                    <div class="mb-4 text-center">
                        <p class="text-xs text-slate-400 font-bold">å…¨é¤¨ç¸½å¹³å‡åœç•™</p>
                        <div id="avg-time" class="stat-val">0s</div>
                    </div>
                    <div class="overflow-y-auto max-h-60">
                        <table id="table-4-2-detail" class="w-full text-left">
                            </table>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="report-card">
                    <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-6ï¼šè§€çœ¾è¡Œç‚ºæ¬¡æ•¸çµ±è¨ˆ</h3>
                    <table class="w-full text-left"><tbody id="table-4-6"></tbody></table>
                </div>
                <div class="report-card">
                    <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-7ï¼šå‹•ç·šæ¨¡å¼é¡å‹åˆ†æ</h3>
                    <div class="flex justify-around py-4">
                        <div class="text-center"><p class="text-xs text-slate-400 font-bold">ç›´ç·šå‹</p><div id="path-linear" class="stat-val text-emerald-500">0</div></div>
                        <div class="text-center"><p class="text-xs text-slate-400 font-bold">è¿´è·¯å‹</p><div id="path-loop" class="stat-val text-amber-500">0</div></div>
                    </div>
                </div>
            </div>

            <div class="report-card overflow-x-auto">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">åŸå§‹ç´€éŒ„æµæ°´å¸³ (åŒ¯å‡ºå°‡åŒ…å«å®Œæ•´æ˜ç´°)</h3>
                <table class="w-full text-left text-xs">
                    <thead><tr class="bg-slate-50"><th class="p-2">ç·¨è™Ÿ</th><th class="p-2">çµ„åˆ</th><th class="p-2">è¡Œç‚º</th><th class="p-2">ä½ç½®åç¨±</th><th class="p-2">æ™‚é–“</th></tr></thead>
                    <tbody id="raw-data-preview"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

    <script>
// --- 1. Firebase é…ç½®èˆ‡åˆå§‹åŒ– ---
const firebaseConfig = {
    apiKey: "AIzaSyDeITI5O-sQ7opy_670e5bMtxP9os16QNs",
    authDomain: "marine-biology-78685.firebaseapp.com",
    databaseURL: "https://marine-biology-78685-default-rtdb.firebaseio.com",
    projectId: "marine-biology-78685",
    storageBucket: "marine-biology-78685.appspot.com",
    messagingSenderId: "287865863826",
    appId: "1:287865863826:web:f622ce81c78613e285f04b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let currentFilteredData = []; // ç”¨æ–¼å­˜å„²ç¯©é¸å¾Œçš„çµæœä¾›å°å‡ºä½¿ç”¨

// --- 2. æ ¸å¿ƒæ•¸æ“šè™•ç†å‡½æ•¸ ---
function filterData(period) {
    const statusEl = document.getElementById('filter-status');
    statusEl.innerText = "ğŸ” æ­£åœ¨å¾é›²ç«¯æŠ“å–æœ€æ–°æ•¸æ“š...";
    
    // å¾ Firebase ç²å–è³‡æ–™
    db.ref('research_data').once('value').then((snapshot) => {
        const rawObject = snapshot.val() || {};
        const rawData = Object.values(rawObject);
        
        if (rawData.length === 0) {
            statusEl.innerText = "âš ï¸ ç›®å‰è³‡æ–™åº«å…§ç„¡ä»»ä½•æ•¸æ“šã€‚";
            return;
        }

        const now = new Date();
        let filtered = rawData;
        
        // åŸ·è¡Œæ—¥æœŸç¯©é¸
        if (period !== 'all') {
            filtered = rawData.filter(d => {
                const entryDate = new Date(d.time);
                if (period === 'day') return entryDate.toDateString() === now.toDateString();
                if (period === 'week') return (now - entryDate) <= 7*24*60*60*1000;
                if (period === 'month') return (now - entryDate) <= 30*24*60*60*1000;
                if (period === 'year') return entryDate.getFullYear() === now.getFullYear();
                return true;
            });
        }

        // æŒ‰æ™‚é–“å…ˆå¾Œæ’åº (å°è¨ˆç®—åœç•™æ™‚é–“è‡³é—œé‡è¦)
        filtered.sort((a, b) => new Date(a.time) - new Date(b.time));
        
        currentFilteredData = filtered;
        statusEl.innerText = `âœ… åŒæ­¥æˆåŠŸï¼é¡¯ç¤ºç­†æ•¸ï¼š${filtered.length} (ç¯©é¸ç¯„åœ: ${period})`;
        renderReports(filtered);
    }).catch(err => {
        console.error(err);
        statusEl.innerText = "âŒ é›²ç«¯è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
    });
}

// --- 3. å ±è¡¨æ¸²æŸ“é‚è¼¯ ---
function renderReports(data) {
    if (!data || data.length === 0) return;

    const uniqueIds = [...new Set(data.map(d => d.id))];
    
    // è¡¨ 4-1ï¼šæˆå“¡çµ„åˆçµ±è¨ˆ
    const gCounts = {};
    uniqueIds.forEach(id => {
        const found = data.find(d => d.id === id);
        if (found) gCounts[found.group] = (gCounts[found.group] || 0) + 1;
    });
    document.getElementById('table-4-1').innerHTML = Object.entries(gCounts)
        .map(([k, v]) => `<tr><td class="table-cell font-bold">${k}</td><td class="table-cell text-right">${v} çµ„</td></tr>`)
        .join('');

    // è¡¨ 4-2ï¼šå„å€åŸŸå¹³å‡åœç•™æ™‚é–“ (é»å°é»è¨ˆç®—)
    const locationDurations = {};
    let totalStaySec = 0;
    let stayCount = 0;

    uniqueIds.forEach(id => {
        const userPoints = data.filter(d => d.id === id); // å·²åœ¨ filterData æ’åºé
        for (let i = 0; i < userPoints.length - 1; i++) {
            const duration = (new Date(userPoints[i+1].time) - new Date(userPoints[i].time)) / 1000;
            const loc = userPoints[i].locName || "æœªå‘½åä½ç½®";

            if (!locationDurations[loc]) locationDurations[loc] = { totalSec: 0, count: 0 };
            locationDurations[loc].totalSec += duration;
            locationDurations[loc].count += 1;
            
            totalStaySec += duration;
            stayCount += 1;
        }
    });

    // æ¸²æŸ“ 4-2 è¡¨æ ¼æ˜ç´°
    let html42 = `<thead><tr class="bg-slate-50"><th class="table-header">è§€æ¸¬ä½ç½®</th><th class="table-header text-right">å¹³å‡åœç•™</th><th class="table-header text-right">æ¨£æœ¬</th></tr></thead><tbody>`;
    Object.entries(locationDurations).forEach(([loc, stat]) => {
        const avg = Math.round(stat.totalSec / stat.count);
        html42 += `<tr><td class="table-cell font-bold">${loc}</td><td class="table-cell text-right text-indigo-600 font-mono">${avg}s</td><td class="table-cell text-right text-slate-400 text-[10px]">${stat.count} æ¬¡</td></tr>`;
    });
    document.getElementById('table-4-2-detail').innerHTML = html42 + `</tbody>`;
    document.getElementById('avg-time').innerText = stayCount ? Math.round(totalStaySec / uniqueIds.length) + "s" : "0s";

    // è¡¨ 4-6ï¼šè¡Œç‚ºçµ±è¨ˆ
    const aCounts = {};
    data.forEach(d => aCounts[d.action] = (aCounts[d.action] || 0) + 1);
    document.getElementById('table-4-6').innerHTML = Object.entries(aCounts)
        .map(([k, v]) => `<tr><td class="table-cell">${k}</td><td class="table-cell text-right font-mono">${v} æ¬¡</td></tr>`)
        .join('');

    // è¡¨ 4-7ï¼šå‹•ç·šæ¨¡å¼ (å„ªåŒ–å®šç¾©ï¼šé»ä½ > 3 ä¸”å›åˆ°åˆå§‹é»é™„è¿‘ç‚ºè¿´è·¯ï¼Œæ­¤è™•ç°¡åŒ–ç‚ºé»ä½æ•¸åˆ¤æ–·)
    let linear = 0, loop = 0;
    uniqueIds.forEach(id => {
        if (data.filter(d => d.id === id).length >= 4) loop++; 
        else linear++;
    });
    document.getElementById('path-linear').innerText = linear;
    document.getElementById('path-loop').innerText = loop;

    // åŸå§‹ç´€éŒ„æµæ°´å¸³é è¦½ (å‰ 15 ç­†)
    document.getElementById('raw-data-preview').innerHTML = data.slice(0, 15).map(d => 
        `<tr class="border-b text-slate-500"><td class="p-2">${d.id}</td><td class="p-2">${d.group}</td><td class="p-2">${d.action}</td><td class="p-2">${d.locName || '-'}</td><td class="p-2 text-[10px]">${new Date(d.time).toLocaleString()}</td></tr>`
    ).join('');
}

// --- 4. åŒ¯å‡º CSV åŠŸèƒ½ ---
function exportToExcel() {
    if (!currentFilteredData.length) return alert("ç›®å‰ç¯©é¸ç¯„åœå…§æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
    
    // åŠ å…¥ BOM \ufeff è§£æ±º Excel ä¸­æ–‡äº‚ç¢¼å•é¡Œ
    let csv = "\ufeffå€‹æ¡ˆç·¨è™Ÿ,æˆå“¡çµ„åˆ,è¡Œç‚ºé …ç›®,ä½ç½®åç¨±,æ‰€åœ¨é¤¨å€,åº§æ¨™X,åº§æ¨™Y,ç´€éŒ„æ™‚é–“\n";
    currentFilteredData.forEach(d => {
        const timeStr = new Date(d.time).toLocaleString().replace(/,/g, ""); // ç§»é™¤é€—é»é¿å…ç ´å£ CSV æ ¼å¼
        csv += `${d.id},${d.group},${d.action},${d.locName || "N/A"},${d.map},${d.x},${d.y},${timeStr}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const fileName = `NMMBA_Research_${new Date().toISOString().slice(0,10)}.csv`;
    
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
}

// åˆå§‹è¼‰å…¥
window.onload = () => filterData('all');
    </script>
</body>
</html>