<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æµ·ç”Ÿé¤¨ç ”ç©¶æ•¸æ“šå®Œæ•´å ±è¡¨ - è¦–è¦ºåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .table-header { background-color: #f1f5f9; color: #475569; font-size: 11px; font-weight: 700; padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
        .table-cell { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-size: 0.875rem; color: #334155; }
        .stat-val { font-size: 1.5rem; font-weight: 900; color: #4f46e5; }
        
        /* åœ°åœ–ç†±åŠ›åœ–æ¨£å¼ */
        .map-analysis-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #f8fafc; }
        .map-analysis-img { width: 100%; height: auto; display: block; opacity: 0.6; }
        .heat-point { position: absolute; background: rgba(79, 70, 229, 0.6); border: 1px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        
        <div class="no-print space-y-4 mb-8">
            <div class="flex justify-between items-center">
                <button onclick="history.back()" class="text-indigo-600 font-bold hover:underline">â¬…ï¸ è¿”å›ç´€éŒ„ç«¯</button>
                <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition-all flex items-center gap-2">
                    ğŸ“Š è¼¸å‡ºå®Œæ•´ CSV å ±è¡¨
                </button>
            </div>

            <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white">
                <h2 class="text-lg font-bold mb-4">ğŸ“… å ±è¡¨æ™‚é–“é€±æœŸç¯©é¸</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                    <button onclick="filterData('all')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">å…¨éƒ¨æ­·å²</button>
                    <button onclick="filterData('day')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">ä»Šæ—¥</button>
                    <button onclick="filterData('week')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">é€±å ±</button>
                    <button onclick="filterData('month')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">æœˆå ±</button>
                    <button onclick="filterData('year')" class="bg-white/20 hover:bg-white/40 p-3 rounded-xl border border-white/30 font-bold">å¹´å ±</button>
                </div>
                <p id="filter-status" class="mt-4 text-indigo-100 text-sm italic italic">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div id="report-content">
            <h1 class="text-3xl font-black text-slate-800 mb-8 border-l-8 border-indigo-600 pl-4">è§€çœ¾è¡Œç‚ºç ”ç©¶åˆ†æè¦–è¦ºåŒ–å ±è¡¨</h1>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-1ï¼šæˆå“¡çµ„åˆçµ±è¨ˆèˆ‡ä½”æ¯”</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <table class="w-full text-left"><tbody id="table-4-1"></tbody></table>
                    <div class="max-h-[300px] flex justify-center">
                        <canvas id="chart-4-1"></canvas>
                    </div>
                </div>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-2ï¼šå„å€åŸŸåœç•™ç†±åŠ›åˆ†æ (åœ“åœˆæ„ˆå¤§åœç•™æ„ˆä¹…)</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="map-analysis-container" id="map-container-map1">
                        <span class="absolute top-2 left-2 bg-black/50 text-white text-[10px] p-1 rounded z-10">è‡ºç£æ°´åŸŸé¤¨</span>
                        <img src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/f9f83808-8917-4d91-be95-98955736b763.jpg" class="map-analysis-img">
                    </div>
                    <div class="map-analysis-container" id="map-container-map2">
                        <span class="absolute top-2 left-2 bg-black/50 text-white text-[10px] p-1 rounded z-10">çŠç‘šç‹åœ‹é¤¨</span>
                        <img src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/aeee9399-5776-4dc9-bc34-74f3de9610ad.jpg" class="map-analysis-img">
                    </div>
                    <div class="map-analysis-container" id="map-container-map3">
                        <span class="absolute top-2 left-2 bg-black/50 text-white text-[10px] p-1 rounded z-10">ä¸–ç•Œæ°´åŸŸé¤¨ 1,2F</span>
                        <img src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/be3ac2e6-4910-4308-9c19-d797081ea4e1.jpg" class="map-analysis-img">
                    </div>
                    <div class="map-analysis-container" id="map-container-map4">
                        <span class="absolute top-2 left-2 bg-black/50 text-white text-[10px] p-1 rounded z-10">ä¸–ç•Œæ°´åŸŸé¤¨ 3F</span>
                        <img src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/c7e10c76-a9aa-49ea-abe4-81066e8fd518.jpg" class="map-analysis-img">
                    </div>
                </div>
                <div class="mb-4 text-center">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">å…¨é¤¨ç¸½å¹³å‡åœç•™æ™‚é–“</p>
                    <div id="avg-time" class="stat-val text-4xl">0s</div>
                </div>
                <div class="overflow-x-auto">
                    <table id="table-4-2-detail" class="w-full text-left"></table>
                </div>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">è¡¨ 4-6ï¼šè§€çœ¾è¡Œç‚ºæ¬¡æ•¸çµ±è¨ˆ</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <table class="w-full text-left"><tbody id="table-4-6"></tbody></table>
                    <div class="max-h-[300px]">
                        <canvas id="chart-4-6"></canvas>
                    </div>
                </div>
            </div>

            <div class="report-card overflow-x-auto">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2">åŸå§‹ç´€éŒ„æµæ°´å¸³ (æœ€æ–° 15 ç­†)</h3>
                <table class="w-full text-left text-xs">
                    <thead><tr class="bg-slate-50"><th class="p-2">ç·¨è™Ÿ</th><th class="p-2">çµ„åˆ</th><th class="p-2">è¡Œç‚º</th><th class="p-2">ä½ç½®åç¨±</th><th class="p-2">æ™‚é–“</th></tr></thead>
                    <tbody id="raw-data-preview"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

    <script>
// Firebase åˆå§‹åŒ–
const firebaseConfig = {
    apiKey: "AIzaSyDeITI5O-sQ7opy_670e5bMtxP9os16QNs",
    authDomain: "marine-biology-78685.firebaseapp.com",
    databaseURL: "https://marine-biology-78685-default-rtdb.firebaseio.com",
    projectId: "marine-biology-78685",
    storageBucket: "marine-biology-78685.appspot.com",
    messagingSenderId: "287865863826",
    appId: "1:287865863826:web:f622ce81c78613e285f04b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let charts = {}; // å­˜æ”¾åœ–è¡¨å¯¦ä¾‹
let currentFilteredData = [];

function filterData(period) {
    document.getElementById('filter-status').innerText = "ğŸ” è®€å–é›²ç«¯æ•¸æ“šä¸­...";
    db.ref('research_data').once('value').then(snapshot => {
        const rawData = Object.values(snapshot.val() || {});
        const now = new Date();
        let filtered = rawData.filter(d => {
            if (period === 'all') return true;
            const entryDate = new Date(d.time);
            if (period === 'day') return entryDate.toDateString() === now.toDateString();
            if (period === 'week') return (now - entryDate) <= 7*86400000;
            if (period === 'month') return (now - entryDate) <= 30*86400000;
            if (period === 'year') return entryDate.getFullYear() === now.getFullYear();
        });
        filtered.sort((a, b) => new Date(a.time) - new Date(b.time));
        currentFilteredData = filtered;
        document.getElementById('filter-status').innerText = `âœ… å®Œæˆï¼ç­†æ•¸ï¼š${filtered.length}`;
        renderReports(filtered);
    });
}

function renderReports(data) {
    if (!data.length) return;
    const uniqueIds = [...new Set(data.map(d => d.id))];

    // --- 4-1 æˆå“¡çµ±è¨ˆ ---
    const gCounts = {};
    uniqueIds.forEach(id => {
        const found = data.find(d => d.id === id);
        if (found) gCounts[found.group] = (gCounts[found.group] || 0) + 1;
    });
    document.getElementById('table-4-1').innerHTML = Object.entries(gCounts)
        .map(([k,v]) => `<tr><td class="table-cell font-bold">${k}</td><td class="table-cell text-right">${v} çµ„</td></tr>`).join('');
    updatePieChart('chart-4-1', gCounts);

    // --- 4-2 åœç•™æ™‚é–“èˆ‡åœ°åœ–åˆ†æ ---
    const locationStats = {}; // ç”¨æ–¼è¡¨æ ¼
    const mapPoints = []; // ç”¨æ–¼ç¹ªè£½åœ“åœˆ
    let totalStaySec = 0;

    uniqueIds.forEach(id => {
        const userPoints = data.filter(d => d.id === id);
        for (let i = 0; i < userPoints.length - 1; i++) {
            const p1 = userPoints[i];
            const p2 = userPoints[i+1];
            const dur = (new Date(p2.time) - new Date(p1.time)) / 1000;
            
            // è¡¨æ ¼é‚è¼¯
            const loc = p1.locName || "æœªå‘½å";
            if (!locationStats[loc]) locationStats[loc] = { total: 0, count: 0 };
            locationStats[loc].total += dur;
            locationStats[loc].count += 1;
            totalStaySec += dur;

            // åœ°åœ–é‚è¼¯
            mapPoints.push({ x: p1.x, y: p1.y, map: p1.map, dur: dur });
        }
    });

    renderMapHeat(mapPoints);
    document.getElementById('avg-time').innerText = uniqueIds.length ? Math.round(totalStaySec/uniqueIds.length) + "s" : "0s";
    let html42 = `<thead><tr class="bg-slate-50"><th class="table-header">è§€æ¸¬ä½ç½®</th><th class="table-header text-right">å¹³å‡åœç•™</th><th class="table-header text-right">æ¨£æœ¬</th></tr></thead><tbody>`;
    Object.entries(locationStats).forEach(([loc, s]) => {
        html42 += `<tr><td class="table-cell font-bold">${loc}</td><td class="table-cell text-right text-indigo-600 font-mono">${Math.round(s.total/s.count)}s</td><td class="table-cell text-right text-slate-400 text-[10px]">${s.count} æ¬¡</td></tr>`;
    });
    document.getElementById('table-4-2-detail').innerHTML = html42 + "</tbody>";

    // --- 4-6 è¡Œç‚ºçµ±è¨ˆ ---
    const aCounts = {};
    data.forEach(d => aCounts[d.action] = (aCounts[d.action] || 0) + 1);
    document.getElementById('table-4-6').innerHTML = Object.entries(aCounts)
        .map(([k,v]) => `<tr><td class="table-cell">${k}</td><td class="table-cell text-right font-mono">${v} æ¬¡</td></tr>`).join('');
    updateBarChart('chart-4-6', aCounts);

    // åŸå§‹æ•¸æ“š
    document.getElementById('raw-data-preview').innerHTML = data.slice(-15).reverse().map(d => 
        `<tr class="border-b text-slate-500"><td class="p-2">${d.id}</td><td class="p-2">${d.group}</td><td class="p-2">${d.action}</td><td class="p-2">${d.locName || '-'}</td><td class="p-2 text-[10px]">${new Date(d.time).toLocaleTimeString()}</td></tr>`
    ).join('');
}

// ç¹ªè£½åœ°åœ–åœ“åœˆ
function renderMapHeat(points) {
    // æ¸…é™¤èˆŠé»
    document.querySelectorAll('.heat-point').forEach(el => el.remove());
    
    // å–å¾—å„åº§æ¨™é»çš„å¹³å‡åœç•™æ™‚é–“
    const coordMap = {};
    points.forEach(p => {
        const key = `${p.map}-${p.x}-${p.y}`;
        if (!coordMap[key]) coordMap[key] = { x: p.x, y: p.y, map: p.map, totalDur: 0, count: 0 };
        coordMap[key].totalDur += p.dur;
        coordMap[key].count += 1;
    });

    Object.values(coordMap).forEach(p => {
        const avgDur = p.totalDur / p.count;
        const mapId = getMapIdByName(p.map);
        const container = document.getElementById(`map-container-${mapId}`);
        if (container) {
            const dot = document.createElement('div');
            dot.className = 'heat-point';
            dot.style.left = `${p.x}%`; // å‡è¨­ç´€éŒ„æ™‚æ˜¯ç›¸å°ç™¾åˆ†æ¯”æˆ–éœ€è½‰æ›ï¼Œæ­¤è™•å‡è¨­ç‚ºåº§æ¨™é»
            // æ³¨æ„ï¼šè‹¥ç´€éŒ„æ™‚æ˜¯ pxï¼Œå»ºè­°åœ¨ç´€éŒ„ç«¯å­˜ç™¾åˆ†æ¯”ï¼Œæ­¤è™•æš«ä»¥ px è¨ˆç®—
            dot.style.left = p.x + 'px';
            dot.style.top = p.y + 'px';
            
            // æ ¹æ“šæ™‚é–“æ±ºå®šå¤§å° (æœ€å° 10px, æ¯ç§’å¢åŠ  2px, æœ€å¤§ 60px)
            const size = Math.min(60, 10 + (avgDur * 1.5));
            dot.style.width = size + 'px';
            dot.style.height = size + 'px';
            container.appendChild(dot);
        }
    });
}

function getMapIdByName(name) {
    if (name.includes("è‡ºç£")) return "map1";
    if (name.includes("çŠç‘š")) return "map2";
    if (name.includes("1,2F")) return "map3";
    return "map4";
}

// åœ–è¡¨è¼”åŠ©å‡½æ•¸
function updatePieChart(id, dataMap) {
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(document.getElementById(id), {
        type: 'pie',
        data: {
            labels: Object.keys(dataMap),
            datasets: [{ data: Object.values(dataMap), backgroundColor: ['#4f46e5', '#818cf8', '#c7d2fe', '#312e81', '#e0e7ff'] }]
        },
        options: { plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
    });
}

function updateBarChart(id, dataMap) {
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(document.getElementById(id), {
        type: 'bar',
        data: {
            labels: Object.keys(dataMap),
            datasets: [{ label: 'æ¬¡æ•¸', data: Object.values(dataMap), backgroundColor: '#4f46e5' }]
        },
        options: { 
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
        }
    });
}

function exportToExcel() {
    let csv = "\ufeffå€‹æ¡ˆç·¨è™Ÿ,æˆå“¡çµ„åˆ,è¡Œç‚ºé …ç›®,ä½ç½®åç¨±,é¤¨å€,æ™‚é–“\n";
    currentFilteredData.forEach(d => {
        csv += `${d.id},${d.group},${d.action},${d.locName},${d.map},${new Date(d.time).toLocaleString()}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `NMMBA_Report_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
}

window.onload = () => filterData('all');
    </script>
</body>
</html>