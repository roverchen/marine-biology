<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·ç”Ÿé¤¨ç ”ç©¶æ•¸æ“šè¦–è¦ºåŒ–å ±è¡¨ - éŸ¿æ‡‰å¼ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-card { background: white; border-radius: 1rem; padding: 1.25rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .table-header { background-color: #f8fafc; color: #64748b; font-size: 11px; font-weight: 700; padding: 0.75rem; border-bottom: 1px solid #e2e8f0; text-transform: uppercase; }
        .table-cell { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; color: #334155; }
        .stat-val { font-size: 1.875rem; font-weight: 900; color: #4f46e5; }
        
        .map-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; }
        @media (min-width: 640px) { .map-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .map-grid { grid-template-columns: repeat(4, 1fr); } }

        .map-analysis-container { 
            position: relative; 
            width: 100%; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #f1f5f9;
            margin-bottom: 10px;
        }

        .map-analysis-img { 
            width: 100%; 
            height: auto; 
            max-height: 400px; 
            object-fit: contain; 
            display: block; 
            opacity: 0.8; 
        }
        .heat-point { position: absolute; background: rgba(79, 70, 229, 0.6); border: 1.5px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; transition: all 0.3s ease; }
        .chart-container { position: relative; height: 260px; width: 100%; }

        /* ç¯©é¸æŒ‰éˆ•é¸ä¸­æ¨£å¼ */
        .filter-btn { transition: all 0.2s; border: 1px solid rgba(255,255,255,0.3); }
        .filter-btn.active { background-color: white !important; color: #4f46e5 !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-slate-50 p-3 md:p-8">
    <div class="max-w-6xl mx-auto">
        
        <div class="no-print space-y-4 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <button onclick="history.back()" class="text-indigo-600 font-bold hover:underline flex items-center gap-1">â¬…ï¸ è¿”å›ç´€éŒ„ç«¯</button>
                <button onclick="exportToExcel()" class="w-full sm:w-auto bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition-all flex justify-center items-center gap-2">
                    ğŸ“Š è¼¸å‡º CSV å ±è¡¨
                </button>
            </div>

            <div class="bg-indigo-600 p-5 rounded-2xl shadow-lg text-white">
                <h2 class="text-sm font-bold mb-3 flex items-center gap-2">ğŸ“… å ±è¡¨æ™‚é–“é€±æœŸç¯©é¸</h2>
                <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-xs" id="filter-group">
                    <button data-period="day" onclick="filterData('day')" class="filter-btn bg-white/20 hover:bg-white/40 py-2 rounded-lg font-bold">ä»Šæ—¥</button>
                    <button data-period="week" onclick="filterData('week')" class="filter-btn bg-white/20 hover:bg-white/40 py-2 rounded-lg font-bold">é€±å ±</button>
                    <button data-period="month" onclick="filterData('month')" class="filter-btn bg-white/20 hover:bg-white/40 py-2 rounded-lg font-bold">æœˆå ±</button>
                    <button data-period="year" onclick="filterData('year')" class="filter-btn bg-white/20 hover:bg-white/40 py-2 rounded-lg font-bold">å¹´å ±</button>
                    <button data-period="all" onclick="filterData('all')" class="filter-btn bg-white/20 hover:bg-white/40 py-2 rounded-lg font-bold">å…¨éƒ¨</button>
                </div>
                <p id="filter-status" class="mt-3 text-indigo-100 text-[10px] italic">åŒæ­¥ä¸­...</p>
            </div>
        </div>

        <div id="report-content">
            <h1 class="text-xl md:text-3xl font-black text-slate-800 mb-6 border-l-4 md:border-l-8 border-indigo-600 pl-3 md:pl-4 tracking-tight">è§€çœ¾è¡Œç‚ºç ”ç©¶è¦–è¦ºåŒ–å ±è¡¨</h1>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2 text-sm md:text-base">è¡¨ 4-1ï¼šæˆå“¡çµ„åˆçµ±è¨ˆèˆ‡ä½”æ¯”</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[200px]"><tbody id="table-4-1"></tbody></table>
                    </div>
                    <div class="chart-container flex justify-center items-center">
                        <canvas id="chart-4-1"></canvas>
                    </div>
                </div>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2 text-sm md:text-base">è¡¨ 4-2ï¼šå„å€åŸŸåœç•™ç†±åŠ›</h3>
                <div class="map-grid mb-6">
                    <div class="map-analysis-container" id="map-container-map1">
                        <span class="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full z-10">è‡ºç£æ°´åŸŸé¤¨</span>
                        <img src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/f9f83808-8917-4d91-be95-98955736b763.jpg" class="map-analysis-img">
                    </div>
                    <div class="map-analysis-container" id="map-container-map2">
                        <span class="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full z-10">çŠç‘šç‹åœ‹é¤¨</span>
                        <img src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/aeee9399-5776-4dc9-bc34-74f3de9610ad.jpg" class="map-analysis-img">
                    </div>
                    <div class="map-analysis-container" id="map-container-map3">
                        <span class="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full z-10">ä¸–ç•Œæ°´åŸŸ 1,2F</span>
                        <img src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/be3ac2e6-4910-4308-9c19-d797081ea4e1.jpg" class="map-analysis-img">
                    </div>
                    <div class="map-analysis-container" id="map-container-map4">
                        <span class="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full z-10">ä¸–ç•Œæ°´åŸŸ 3F</span>
                        <img src="https://ws.nmmba.gov.tw/001/Upload/226/ckfile/c7e10c76-a9aa-49ea-abe4-81066e8fd518.jpg" class="map-analysis-img">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 flex flex-col justify-center items-center p-4 bg-indigo-50 rounded-xl">
                        <p class="text-[10px] text-indigo-400 font-bold uppercase tracking-wider">å¹³å‡åœç•™æ™‚é–“</p>
                        <div id="avg-time" class="stat-val">0s</div>
                    </div>
                    <div class="md:col-span-2 overflow-x-auto">
                        <table id="table-4-2-detail" class="w-full text-left"></table>
                    </div>
                </div>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2 text-sm md:text-base">è¡¨ 4-6ï¼šè§€çœ¾è¡Œç‚ºæ¬¡æ•¸çµ±è¨ˆ</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
                    <div class="overflow-x-auto order-2 lg:order-1">
                        <table class="w-full text-left min-w-[200px]"><tbody id="table-4-6"></tbody></table>
                    </div>
                    <div class="chart-container order-1 lg:order-2">
                        <canvas id="chart-4-6"></canvas>
                    </div>
                </div>
            </div>

            <div class="report-card">
                <h3 class="font-black text-indigo-600 mb-4 border-b pb-2 text-sm md:text-base">æœ€æ–° 15 ç­†åŸå§‹æµæ°´å¸³</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[10px] md:text-xs">
                        <thead><tr class="bg-slate-50"><th class="p-2">ç·¨è™Ÿ</th><th class="p-2">çµ„åˆ</th><th class="p-2">è¡Œç‚º</th><th class="p-2">ä½ç½®</th><th class="p-2">æ™‚é–“</th></tr></thead>
                        <tbody id="raw-data-preview"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDeITI5O-sQ7opy_670e5bMtxP9os16QNs",
            authDomain: "marine-biology-78685.firebaseapp.com",
            databaseURL: "https://marine-biology-78685-default-rtdb.firebaseio.com",
            projectId: "marine-biology-78685",
            storageBucket: "marine-biology-78685.appspot.com",
            messagingSenderId: "287865863826",
            appId: "1:287865863826:web:f622ce81c78613e285f04b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let charts = {};
        let currentFilteredData = [];

        function filterData(period) {
            updateButtonUI(period); // æ›´æ–°æŒ‰éˆ•è¦–è¦º
            document.getElementById('filter-status').innerText = "ğŸ” åŒæ­¥æ•¸æ“šä¸­...";
            
            db.ref('research_data').once('value').then(snapshot => {
                const rawData = Object.values(snapshot.val() || {});
                const now = new Date();
                let filtered = rawData.filter(d => {
                    if (period === 'all') return true;
                    const entryDate = new Date(d.time);
                    if (period === 'day') return entryDate.toDateString() === now.toDateString();
                    if (period === 'week') return (now - entryDate) <= 7*86400000;
                    if (period === 'month') return (now - entryDate) <= 30*86400000;
                    if (period === 'year') return entryDate.getFullYear() === now.getFullYear();
                });
                filtered.sort((a, b) => new Date(a.time) - new Date(b.time));
                currentFilteredData = filtered;
                document.getElementById('filter-status').innerText = `âœ… å®Œæˆ (ç­†æ•¸: ${filtered.length})`;
                renderReports(filtered);
            });
        }

        // è¦–è¦ºåŒ–å›é¥‹ï¼šæ¨™ç¤ºç›®å‰é¸ä¸­çš„ç¯©é¸å™¨
        function updateButtonUI(period) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.getAttribute('data-period') === period) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // å…¶é¤˜æ¸²æŸ“å‡½å¼ (renderReports, renderMapHeat, etc.) ä¿æŒä¸è®Š...
        function renderReports(data) {
            if (!data.length) {
                // è‹¥ç„¡æ•¸æ“šï¼Œæ¸…ç©ºåœ–è¡¨èˆ‡å…§å®¹
                document.getElementById('avg-time').innerText = "0s";
                return;
            };
            const uniqueIds = [...new Set(data.map(d => d.id))];

            // 4-1 æˆå“¡çµ±è¨ˆ
            const gCounts = {};
            uniqueIds.forEach(id => {
                const found = data.find(d => d.id === id);
                if (found) gCounts[found.group] = (gCounts[found.group] || 0) + 1;
            });
            document.getElementById('table-4-1').innerHTML = Object.entries(gCounts)
                .map(([k,v]) => `<tr><td class="table-cell font-bold">${k}</td><td class="table-cell text-right">${v} çµ„</td></tr>`).join('');
            updatePieChart('chart-4-1', gCounts);

            // 4-2 åœç•™æ™‚é–“èˆ‡åœ°åœ–åˆ†æ
            const locationStats = {};
            const mapPoints = []; 
            let totalStaySec = 0;

            uniqueIds.forEach(id => {
                const userPoints = data.filter(d => d.id === id);
                for (let i = 0; i < userPoints.length - 1; i++) {
                    const p1 = userPoints[i];
                    const p2 = userPoints[i+1];
                    const dur = (new Date(p2.time) - new Date(p1.time)) / 1000;
                    const loc = p1.locName || "æœªå‘½å";
                    if (!locationStats[loc]) locationStats[loc] = { total: 0, count: 0 };
                    locationStats[loc].total += dur;
                    locationStats[loc].count += 1;
                    totalStaySec += dur;
                    if(p1.x_pct) mapPoints.push({ x: p1.x_pct, y: p1.y_pct, map: p1.map, dur: dur });
                }
            });

            renderMapHeat(mapPoints);
            document.getElementById('avg-time').innerText = uniqueIds.length ? Math.round(totalStaySec/uniqueIds.length) + "s" : "0s";
            let html42 = `<thead><tr class="bg-slate-50"><th class="table-header">å€åŸŸ</th><th class="table-header text-right">å¹³å‡</th><th class="table-header text-right">æ¨£æœ¬</th></tr></thead><tbody>`;
            Object.entries(locationStats).sort((a,b) => b[1].total/b[1].count - a[1].total/a[1].count).forEach(([loc, s]) => {
                html42 += `<tr><td class="table-cell font-bold">${loc}</td><td class="table-cell text-right text-indigo-600 font-mono">${Math.round(s.total/s.count)}s</td><td class="table-cell text-right text-slate-400 text-[10px]">${s.count}æ¬¡</td></tr>`;
            });
            document.getElementById('table-4-2-detail').innerHTML = html42 + "</tbody>";

            // 4-6 è¡Œç‚ºçµ±è¨ˆ
            const aCounts = {};
            data.forEach(d => aCounts[d.action] = (aCounts[d.action] || 0) + 1);
            document.getElementById('table-4-6').innerHTML = Object.entries(aCounts)
                .map(([k,v]) => `<tr><td class="table-cell">${k}</td><td class="table-cell text-right font-mono text-indigo-600">${v}</td></tr>`).join('');
            updateBarChart('chart-4-6', aCounts);

            // åŸå§‹æ•¸æ“š
            document.getElementById('raw-data-preview').innerHTML = data.slice(-15).reverse().map(d => 
                `<tr class="border-b text-slate-500"><td class="p-2">${d.id}</td><td class="p-2">${d.group}</td><td class="p-2">${d.action}</td><td class="p-2">${d.locName || '-'}</td><td class="p-2 text-[10px]">${new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td></tr>`
            ).join('');
        }

        function renderMapHeat(points) {
            document.querySelectorAll('.heat-point').forEach(el => el.remove());
            const coordMap = {};
            points.forEach(p => {
                const key = `${p.map}-${Math.round(p.x)}-${Math.round(p.y)}`;
                if (!coordMap[key]) coordMap[key] = { x: p.x, y: p.y, map: p.map, totalDur: 0, count: 0 };
                coordMap[key].totalDur += p.dur;
                coordMap[key].count += 1;
            });
            Object.values(coordMap).forEach(p => {
                const avgDur = p.totalDur / p.count;
                const mapId = getMapIdByName(p.map);
                const container = document.getElementById(`map-container-${mapId}`);
                if (container) {
                    const dot = document.createElement('div');
                    dot.className = 'heat-point';
                    dot.style.left = `${p.x}%`;
                    dot.style.top = `${p.y}%`;
                    const size = Math.min(30, 8 + (avgDur * 0.1)); 
                    dot.style.width = size + 'px';
                    dot.style.height = size + 'px';
                    container.appendChild(dot);
                }
            });
        }

        function getMapIdByName(name) {
            if (name.includes("è‡ºç£")) return "map1";
            if (name.includes("çŠç‘š")) return "map2";
            if (name.includes("1,2F")) return "map3";
            return "map4";
        }

        function updatePieChart(id, dataMap) {
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{ data: Object.values(dataMap), backgroundColor: ['#4f46e5', '#818cf8', '#c7d2fe', '#312e81', '#e0e7ff'], borderWeight: 0 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });
        }

        function updateBarChart(id, dataMap) {
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{ label: 'æ¬¡æ•¸', data: Object.values(dataMap), backgroundColor: '#818cf8', borderRadius: 4 }]
                },
                options: { maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } }
            });
        }

        function exportToExcel() {
            let csv = "\ufeffå€‹æ¡ˆç·¨è™Ÿ,æˆå“¡çµ„åˆ,è¡Œç‚ºé …ç›®,ä½ç½®åç¨±,é¤¨å€,æ™‚é–“\n";
            currentFilteredData.forEach(d => { csv += `${d.id},${d.group},${d.action},${d.locName},${d.map},${new Date(d.time).toLocaleString()}\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `NMMBA_Report_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        // ğŸ’¡ åˆå§‹å€¼æ”¹ç‚º 'day'
        window.onload = () => filterData('day');
    </script>
</body>
</html>